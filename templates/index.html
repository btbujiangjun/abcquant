<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>基于LLM的股票K线分析系统</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f4f6f8; margin:0; padding:20px; }
        .container { max-width:1200px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align:center; color:#2c3e50; }
        .toolbar { display:flex; gap:10px; margin-bottom:20px; }
        input,select,button { padding:10px; border:1px solid #ccc; border-radius:4px; }
        input { flex:1; }
        button { background-color:#3498db; color:white; border:none; cursor:pointer; }
        button:hover { background-color:#2980b9; }
        #chart { height:600px; margin-top:20px; }
        #stockInfo { background:#f8f9fa; border-radius:8px; padding:10px; margin-bottom:15px; font-size:14px; color:#555; line-height:1.6; cursor:pointer; }
        #customTable { width:100%; border-collapse: collapse; margin-top:20px; font-size:14px; }
        #customTable th, #customTable td { border:1px solid #ccc; padding:8px; text-align:left; }
        #customTable th { background:#f0f0f0; text-align: center;}
    </style>
</head>
<body>
<div class="container">
    <h1>📈 基于LLM的股票K线分析系统</h1>
    <div class="toolbar">
        <select id="stockSelector"></select>
        <input type="text" id="stockSearch" placeholder="输入股票代码或名称搜索">
        <select id="intervalSelector">
            <option value="1min">1分钟</option>
            <option value="5min">5分钟</option>
            <option value="15min">15分钟</option>
            <option value="30min">30分钟</option>
            <option value="60min">1小时</option>
            <option value="daily" selected>日线</option>
            <option value="weekly">周线</option>
            <option value="monthly">月线</option>
        </select>
        <button onclick="searchStock()">查询</button>
    </div>

    <div id="stockInfo">
        <div id="stockInfoSummary">点击查看股票基本信息</div>
        <div id="stockInfoDetail" style="display:none;"></div>
    </div>

    <div id="chart"></div>

    <table id="customTable">
        <thead>
            <tr><th colspan="4">分析报告</th></tr>
        </thead>
        <tbody id="customTableBody">
            <tr><td>请选择股票加载分析报告</td></tr>
        </tbody>
    </table>
</div>

<script>
let chart, candleSeries, volumeSeries, ema5Series, ema20Series;
let currentSymbol = '';
let latestKlines = [];

function initChart(){
    chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: document.getElementById('chart').clientWidth,
        height:600,
        layout:{background:{color:'#fff'}, textColor:'#333'},
        grid:{vertLines:{color:'#eee'}, horzLines:{color:'#eee'}},
        timeScale:{timeVisible:true}
    });
    candleSeries = chart.addCandlestickSeries({upColor:'#26a69a', downColor:'#ef5350', borderUpColor:'#26a69a', borderDownColor:'#ef5350', wickUpColor:'#26a69a', wickDownColor:'#ef5350'});
    volumeSeries = chart.addHistogramSeries({color:'#26a69a', priceFormat:{type:'volume'}, priceScaleId:'', scaleMargins:{top:0.8,bottom:0}});
    ema5Series = chart.addLineSeries({color:'#f39c12', lineWidth:2});
    ema20Series = chart.addLineSeries({color:'#2980b9', lineWidth:2});
}

function calculateEMA(data, period){
    const k = 2/(period+1); const emaArray=[]; let emaPrev = data[0].close;
    data.forEach((d,i)=>{const ema=i===0?d.close:d.close*k+emaPrev*(1-k); emaArray.push(ema); emaPrev=ema;});
    return emaArray;
}

function getColorByScore(score){
    if(score>=0.5) return '#27ae60';
    else if(score>=0.2) return '#f1c40f';
    else return '#c0392b';
}

async function loadStocks(){
    const response = await fetch('/stocks'); const stocks=await response.json();
    const selector=document.getElementById('stockSelector'); selector.innerHTML='<option value="">选择股票</option>';
    stocks.forEach(stock=>{const opt=document.createElement('option'); opt.value=stock.symbol; opt.textContent=`${stock.symbol}`; selector.appendChild(opt);});
    selector.onchange=()=>{const s=selector.value; if(s){currentSymbol=s; searchStock(s); document.getElementById('stockSearch').value=s;}};
    if(stocks.length>0){ currentSymbol=stocks[0].symbol; selector.value=currentSymbol; document.getElementById('stockSearch').value=currentSymbol; searchStock(currentSymbol);}
}

function formatMarketCap(value){ if(!value) return 'N/A'; return (value/1e8).toFixed(2)+'亿'; }

function getRandomColor() {
  const palette = ['#42a5f5', '#ef5350', '#66bb6a', '#ab47bc', '#ffa726', '#26c6da', '#ffca28'];
  return palette[Math.floor(Math.random() * palette.length)];
}

// 指标对应颜色库
const indicatorColors = {
  EMA: ['#42a5f5','#64b5f6','#2196f3'],
  MACD: ['#ab47bc','#8e24aa','#ba68c8'],
  VOL: ['#ffa726','#fb8c00','#ffb74d'],
  PRICE: ['#ef5350','#e53935','#f44336']
};

// 随机获取数组内颜色
function getRandomFromArray(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function showReport(text){
  return text
    .replace(/^#### (.*)$/gm, (_, title) => `<h4 style="color:${getRandomFromArray(indicatorColors.MACD)};margin:3px 0 2px;font-size:14px;font-weight:600;">${title}</h4>`)
    .replace(/^### (.*)$/gm, (_, title) => `<h3 style="color:${getRandomFromArray(indicatorColors.EMA)};margin:5px 0 3px;font-size:15px;font-weight:700;">${title}</h3>`)
    .replace(/\b(EMA)\b/g, m => `<span style="color:${getRandomFromArray(indicatorColors.EMA)};font-weight:600;">${m}</span>`)
    .replace(/\b(MACD)\b/g, m => `<span style="color:${getRandomFromArray(indicatorColors.MACD)};font-weight:600;">${m}</span>`)
    .replace(/\b(成交量|VOL)\b/g, m => `<span style="color:${getRandomFromArray(indicatorColors.VOL)};font-weight:600;">${m}</span>`)
    // 粗体文字
    .replace(/\*\*(.*?)\*\*/g, `<b style="color:${getRandomColor()};">$1</b>`)
    // 冒号型列表美化
    .replace(/- ([^:]+)：/g, `<span style="color:${getRandomColor()};">• $1：</span>`)
    // 综合评分标签
    .replace(/<score>(.*?)<\/score>/g, (macth, p1) => {const score = parseFloat(p1); const color = getColorByScore(score); return `<div style="margin:4px 0;padding:4px 8px;border-left:3px solid #43a047;background:#f1f8e9;font-size:14px;display:inline-block;">综合评分：<b><span style="color:${color};">${score}</span></b></div>`})
    // 普通换行 → <br>
    .replace(/\n/g, '<br>');
}

async function loadStockInfo(symbol){
    const response=await fetch(`/stock_info/${symbol}`);
    if(!response.ok) return;
    const info=await response.json();
    const detailDiv=document.getElementById('stockInfoDetail');
    detailDiv.innerHTML=`<b>${info.symbol}</b> - ${info.name}<br>行业: <b>${info.industry||'未知'}</b> | 市值:<b>${formatMarketCap(info.market_cap)}</b><br>info: ${info.info||'-'}`;
    const summaryDiv=document.getElementById('stockInfoSummary');
    summaryDiv.onclick=()=>{if(detailDiv.style.display==='none'){detailDiv.style.display='block'; summaryDiv.innerText='点击收起股票基本信息';} else {detailDiv.style.display='none'; summaryDiv.innerText='点击查看股票基本信息';}};
}

async function searchStock(symbol=null){
    sym=symbol||document.getElementById('stockSearch').value.trim()||document.getElementById('stockSelector').value;
    sym=sym.toUpperCase()
    const interval=document.getElementById('intervalSelector').value;
    if(!sym){alert('请输入或选择股票代码'); return;} currentSymbol=sym;
    await loadStockInfo(sym);

    const response=await fetch(`/klines/${sym}?interval=${interval}`);
    if(!response.ok){alert('未找到该股票的K线数据'); return;}
    const klines=await response.json(); latestKlines=klines;
    const formatted=klines.map(k=>({time:k.date,open:k.open,high:k.high,low:k.low,close:k.close}));
    candleSeries.setData(formatted); chart.timeScale().fitContent();
    const volData=klines.map(k=>({time:k.date,value:k.volume,color:k.close>=k.open?'#26a69a':'#ef5350'}));
    volumeSeries.setData(volData);
    const ema5=calculateEMA(formatted,5);
    const ema20=calculateEMA(formatted,20);
    ema5Series.setData(formatted.map((d,i)=>({time:d.time,value:ema5[i]})));
    ema20Series.setData(formatted.map((d,i)=>({time:d.time,value:ema20[i]})));

    const reportResp=await fetch(`/quant_report/${sym}`); let reportData=[];
    if(reportResp.ok){ reportData=await reportResp.json();}
    const tbody=document.getElementById('customTableBody'); tbody.innerHTML='';
    const tableHead = document.querySelector('#customTable thead tr th');
    tableHead.colSpan = 4;
    tableHead.innerHTML = currentSymbol ? `${currentSymbol} 分析报告` : '分析报告';
    if(reportData.length>0){
        reportData.sort((a,b)=>new Date(b.date)-new Date(a.date));
        const headerTr=document.createElement('tr');
        headerTr.style.textAlign='center'; 
        //headerTr.innerHTML=`<th>日期</th><th>收盘价</th><th>📊滤网</th><th>滤网报告</th><th>🔽双底</th><th>双底报告</th><th>🔼双顶</th><th>双顶报告</th><th>🏺杯柄</th><th>杯柄报告</th>`;
        headerTr.innerHTML=`<th>日期</th><th>收盘价</th><th>📊滤网</th><th>滤网报告</th>`;
        tbody.appendChild(headerTr);
        reportData.forEach(row=>{const tr=document.createElement('tr'); tr.innerHTML=`
            <td style="width:120px"><b>${row.date}</b></br>更新:${row.update_time}</td>
            <td style="width:80px"><b>${row.price?.toFixed(2)||'-'}</b></td>
            <td style="color:${getColorByScore(row.three_filters_score)}; font-size:30px">${row.three_filters_score??'-'}</td>
            <td style="vertical-align: top;">${showReport(row.three_filters_report)||'-'}</td>`; tbody.appendChild(tr);});
    } else { tbody.innerHTML='<tr><td>暂无分析报告</td></tr>'; }
}

document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('intervalSelector').onchange=()=>{if(currentSymbol) searchStock(currentSymbol);};
});

window.onload=()=>{initChart(); loadStocks();};
window.onresize=()=>chart.applyOptions({width:document.getElementById('chart').clientWidth});
</script>
</body>
</html>


