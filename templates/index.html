<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>åŸºäºLLMçš„è‚¡ç¥¨Kçº¿åˆ†æç³»ç»Ÿ</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f4f6f8; margin:0; padding:20px; }
        .container { max-width:1200px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align:center; color:#2c3e50; }
        .toolbar { display:flex; gap:10px; margin-bottom:20px; }
        input,select,button { padding:10px; border:1px solid #ccc; border-radius:4px; }
        input { flex:1; }
        button { background-color:#3498db; color:white; border:none; cursor:pointer; }
        button:hover { background-color:#2980b9; }
        #chart { height:600px; margin-top:20px; }
        #stockInfo { background:#f8f9fa; border-radius:8px; padding:10px; margin-bottom:15px; font-size:14px; color:#555; line-height:1.6; cursor:pointer; }
        #customTable { width:100%; border-collapse: collapse; margin-top:20px; font-size:14px; }
        #customTable th, #customTable td { border:1px solid #ccc; padding:8px; text-align:left; }
        #customTable th { background:#f0f0f0; }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“ˆ åŸºäºLLMçš„è‚¡ç¥¨Kçº¿åˆ†æç³»ç»Ÿ</h1>
    <div class="toolbar">
        <select id="stockSelector"></select>
        <input type="text" id="stockSearch" placeholder="è¾“å…¥è‚¡ç¥¨ä»£ç æˆ–åç§°æœç´¢">
        <select id="intervalSelector">
            <option value="1min">1åˆ†é’Ÿ</option>
            <option value="5min">5åˆ†é’Ÿ</option>
            <option value="15min">15åˆ†é’Ÿ</option>
            <option value="30min">30åˆ†é’Ÿ</option>
            <option value="60min">1å°æ—¶</option>
            <option value="daily" selected>æ—¥çº¿</option>
            <option value="weekly">å‘¨çº¿</option>
            <option value="monthly">æœˆçº¿</option>
        </select>
        <button onclick="searchStock()">æŸ¥è¯¢</button>
    </div>

    <div id="stockInfo">
        <div id="stockInfoSummary">ç‚¹å‡»æŸ¥çœ‹è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯</div>
        <div id="stockInfoDetail" style="display:none;"></div>
    </div>

    <div id="chart"></div>

    <table id="customTable">
        <thead>
            <tr><th colspan="10">åˆ†ææŠ¥å‘Š</th></tr>
        </thead>
        <tbody id="customTableBody">
            <tr><td>è¯·é€‰æ‹©è‚¡ç¥¨åŠ è½½åˆ†ææŠ¥å‘Š</td></tr>
        </tbody>
    </table>
</div>

<script>
let chart, candleSeries, volumeSeries, ema5Series, ema20Series;
let currentSymbol = '';
let latestKlines = [];

function initChart(){
    chart = LightweightCharts.createChart(document.getElementById('chart'), {
        width: document.getElementById('chart').clientWidth,
        height:600,
        layout:{background:{color:'#fff'}, textColor:'#333'},
        grid:{vertLines:{color:'#eee'}, horzLines:{color:'#eee'}},
        timeScale:{timeVisible:true}
    });
    candleSeries = chart.addCandlestickSeries({upColor:'#26a69a', downColor:'#ef5350', borderUpColor:'#26a69a', borderDownColor:'#ef5350', wickUpColor:'#26a69a', wickDownColor:'#ef5350'});
    volumeSeries = chart.addHistogramSeries({color:'#26a69a', priceFormat:{type:'volume'}, priceScaleId:'', scaleMargins:{top:0.8,bottom:0}});
    ema5Series = chart.addLineSeries({color:'#f39c12', lineWidth:2});
    ema20Series = chart.addLineSeries({color:'#2980b9', lineWidth:2});
}

function calculateEMA(data, period){
    const k = 2/(period+1); const emaArray=[]; let emaPrev = data[0].close;
    data.forEach((d,i)=>{const ema=i===0?d.close:d.close*k+emaPrev*(1-k); emaArray.push(ema); emaPrev=ema;});
    return emaArray;
}

function getColorByScore(score){
    if(score>=0.5) return '#27ae60';
    else if(score>=0.2) return '#f1c40f';
    else return '#c0392b';
}

async function loadStocks(){
    const response = await fetch('/stocks'); const stocks=await response.json();
    const selector=document.getElementById('stockSelector'); selector.innerHTML='<option value="">é€‰æ‹©è‚¡ç¥¨</option>';
    stocks.forEach(stock=>{const opt=document.createElement('option'); opt.value=stock.symbol; opt.textContent=`${stock.symbol}`; selector.appendChild(opt);});
    selector.onchange=()=>{const s=selector.value; if(s){currentSymbol=s; searchStock(s); document.getElementById('stockSearch').value=s;}};
    if(stocks.length>0){ currentSymbol=stocks[0].symbol; selector.value=currentSymbol; document.getElementById('stockSearch').value=currentSymbol; searchStock(currentSymbol);}
}

function formatMarketCap(value){ if(!value) return 'N/A'; return (value/1e8).toFixed(2)+'äº¿'; }

async function loadStockInfo(symbol){
    const response=await fetch(`/stock_info/${symbol}`);
    if(!response.ok) return;
    const info=await response.json();
    const detailDiv=document.getElementById('stockInfoDetail');
    detailDiv.innerHTML=`<b>${info.symbol}</b> - ${info.name}<br>è¡Œä¸š: <b>${info.industry||'æœªçŸ¥'}</b> | å¸‚å€¼:<b>${formatMarketCap(info.market_cap)}</b><br>info: ${info.info||'-'}`;
    const summaryDiv=document.getElementById('stockInfoSummary');
    summaryDiv.onclick=()=>{if(detailDiv.style.display==='none'){detailDiv.style.display='block'; summaryDiv.innerText='ç‚¹å‡»æ”¶èµ·è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯';} else {detailDiv.style.display='none'; summaryDiv.innerText='ç‚¹å‡»æŸ¥çœ‹è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯';}};
}

async function searchStock(symbol=null){
    sym=symbol||document.getElementById('stockSearch').value.trim()||document.getElementById('stockSelector').value;
    sym=sym.toUpperCase()
    const interval=document.getElementById('intervalSelector').value;
    if(!sym){alert('è¯·è¾“å…¥æˆ–é€‰æ‹©è‚¡ç¥¨ä»£ç '); return;} currentSymbol=sym;
    await loadStockInfo(sym);

    const response=await fetch(`/klines/${sym}?interval=${interval}`);
    if(!response.ok){alert('æœªæ‰¾åˆ°è¯¥è‚¡ç¥¨çš„Kçº¿æ•°æ®'); return;}
    const klines=await response.json(); latestKlines=klines;
    const formatted=klines.map(k=>({time:k.date,open:k.open,high:k.high,low:k.low,close:k.close}));
    candleSeries.setData(formatted); chart.timeScale().fitContent();
    const volData=klines.map(k=>({time:k.date,value:k.volume,color:k.close>=k.open?'#26a69a':'#ef5350'}));
    volumeSeries.setData(volData);
    const ema5=calculateEMA(formatted,5);
    const ema20=calculateEMA(formatted,20);
    ema5Series.setData(formatted.map((d,i)=>({time:d.time,value:ema5[i]})));
    ema20Series.setData(formatted.map((d,i)=>({time:d.time,value:ema20[i]})));

    const reportResp=await fetch(`/quant_report/${sym}`); let reportData=[];
    if(reportResp.ok){ reportData=await reportResp.json();}
    const tbody=document.getElementById('customTableBody'); tbody.innerHTML='';
    if(reportData.length>0){
        reportData.sort((a,b)=>new Date(b.date)-new Date(a.date));
        const headerTr=document.createElement('tr');
        headerTr.style.textAlign='center'; 
        headerTr.innerHTML=`<th>æ—¥æœŸ</th><th>æ”¶ç›˜ä»·</th><th>ğŸ“Šæ»¤ç½‘</th><th>æ»¤ç½‘æŠ¥å‘Š</th><th>ğŸ”½åŒåº•</th><th>åŒåº•æŠ¥å‘Š</th><th>ğŸ”¼åŒé¡¶</th><th>åŒé¡¶æŠ¥å‘Š</th><th>ğŸºæ¯æŸ„</th><th>æ¯æŸ„æŠ¥å‘Š</th>`;
        tbody.appendChild(headerTr);
        reportData.forEach(row=>{const tr=document.createElement('tr'); tr.innerHTML=`
            <td>${row.date}</td>
            <td>${row.price?.toFixed(2)||'-'}</td>
            <td style="color:${getColorByScore(row.three_filters_score)}; font-size:20px">${row.three_filters_score??'-'}</td>
            <td style="vertical-align: top;">${row.three_filters_report||'-'}</td>
            <td style="color:${getColorByScore(row.double_bottom_score)}; font-size:20px">${row.double_bottom_score??'-'}</td>
            <td style="vertical-align: top;">${row.double_bottom_report||'-'}</td>
            <td style="color:${getColorByScore(row.double_top_score)}; font-size:20px">${row.double_top_score??'-'}</td>
            <td style="vertical-align: top;">${row.double_top_report||'-'}</td>
            <td style="color:${getColorByScore(row.cup_handle_score)}; font-size:20px">${row.cup_handle_score??'-'}</td>
            <td style="vertical-align: top;">${row.cup_handle_report||'-'}</td>`; tbody.appendChild(tr);});
    } else { tbody.innerHTML='<tr><td>æš‚æ— åˆ†ææŠ¥å‘Š</td></tr>'; }
}

document.addEventListener('DOMContentLoaded', ()=>{
    document.getElementById('intervalSelector').onchange=()=>{if(currentSymbol) searchStock(currentSymbol);};
});

window.onload=()=>{initChart(); loadStocks();};
window.onresize=()=>chart.applyOptions({width:document.getElementById('chart').clientWidth});
</script>
</body>
</html>


