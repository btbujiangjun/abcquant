<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>基于LLM的股票K线分析系统</title>
<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
body { margin:0; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif; background:#f4f6f8; }
.main-container { display:flex; height:100vh; }
.sidebar { width:220px; background:#2c3e50; color:#fff; display:flex; flex-direction:column; transition: width 0.3s; }
.sidebar.collapsed { width:50px; }
.sidebar h2 { text-align:center; padding:15px 0; font-size:16px; margin:0; border-bottom:1px solid #34495e; white-space: nowrap; overflow: hidden; }
.tab-btn { padding:12px 15px; cursor:pointer; border:none; background:none; color:#fff; text-align:left; border-bottom:1px solid #34495e; transition:0.3s; white-space: nowrap; overflow: hidden; }
.tab-btn:hover, .tab-btn.active { background:#34495e; }
.toggle-btn { padding:12px; cursor:pointer; background:#1abc9c; border:none; color:#fff; font-size:16px; }
.content { flex:1; padding:20px; overflow:auto; }
.tab-content { display:none; }
.tab-content.active { display:block; }
.toolbar { display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; }
input,select,button { padding:10px; border:1px solid #ccc; border-radius:4px; }
input { flex:1; min-width:120px; }
button { background-color:#3498db; color:white; border:none; cursor:pointer; }
button:hover { background-color:#2980b9; }
#chart, #scoreChart { margin-top:20px; }
#chart { height:600px; }
#scoreChart { height:300px; }
#stockInfo { background:#f8f9fa; border-radius:8px; padding:10px; margin-bottom:15px; font-size:14px; color:#555; line-height:1.6; cursor:pointer; }
#customTable { width:100%; border-collapse: collapse; margin-top:20px; font-size:14px; }
#customTable th, #customTable td { border:1px solid #ccc; padding:8px; text-align:left; }
#customTable th { background:#f0f0f0; text-align: center;}
@keyframes fadeIn { from { opacity:0; transform:translateY(-5px);} to { opacity:1; transform:translateY(0);} }
.gradient-title { background: linear-gradient(90deg, #42a5f5, #66bb6a, #ffa726, #ab47bc); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700; font-size:18px; letter-spacing:1px; animation:fadeIn 0.6s ease; text-align:center; margin-bottom:10px; }
.gradient-h1-title { background: linear-gradient(90deg, #42a5f5, #66bb6a, #ffa726, #ab47bc); -webkit-background-clip:text; -webkit-text-fill-color:transparent; font-weight:700; font-size:28px; letter-spacing:1px; animation:fadeIn 0.6s ease; text-align:center; margin-bottom:10px; }
/* 新增：滤网摘要卡片与评分徽章 */
.summary-card { background: linear-gradient(180deg,#ffffff,#f7fbff); border-radius:8px; padding:12px; box-shadow:0 2px 8px rgba(0,0,0,0.05); margin-bottom:12px; display:flex; gap:12px; align-items:center; }
.summary-left { flex:1; }
.summary-score { min-width:110px; text-align:center; border-radius:8px; padding:10px; font-size:18px; font-weight:700; color:#fff; }
.score-green { background:linear-gradient(90deg,#27ae60,#2ecc71); }
.score-yellow { background:linear-gradient(90deg,#f39c12,#f1c40f); color:#222; }
.score-red { background:linear-gradient(90deg,#c0392b,#e74c3c); }
.small-tag { background:#eef6ff; padding:4px 8px; border-radius:6px; font-size:12px; color:#0b66b3; margin-right:6px; display:inline-block; }

.report-key { font-size:13px; color:#333; margin:2px 0; }
.badge { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px; background:#f1f8e9; color:#2b7a2b; }

/* chart score floating badge */
.chart-badge { position:absolute; right:40px; top:28px; z-index:20; border-radius:8px; padding:10px 14px; font-weight:800; color:#fff; box-shadow:0 6px 18px rgba(0,0,0,0.12); }
.chart-badge.small { padding:6px 10px; font-weight:700; font-size:14px; }
</style>
</head>
<body>
<div class="main-container">
    <div class="sidebar" id="sidebar">
        <h2>功能导航</h2>
        <button class="tab-btn active" data-tab="tab1">股票分析💹</button>
        <button class="tab-btn" data-tab="tab2">🐲龙🐯榜🔥</button>
        <button class="tab-btn" data-tab="tab3">其他功能2</button>
        <button class="toggle-btn" id="toggleSidebar">⏴</button>
    </div>
    <div class="content" id="content">
        <div class="tab-content active" id="tab1">
            <h1>🚀<span class="gradient-h1-title">基于LLM的股票K线分析系统</span>💰</h1>
            <div class="toolbar">
                <select id="stockSelector"></select>
                <input type="text" id="stockSearch" placeholder="输入股票代码或名称搜索">
                <select id="intervalSelector">
                    <!--
                    <option value="1min">1分钟</option>
                    <option value="5min">5分钟</option>
                    <option value="15min">15分钟</option>
                    <option value="30min">30分钟</option>
                    <option value="60min">1小时</option>
                    -->
                    <option value="daily" selected>日线</option>
                    <option value="weekly">周线</option>
                    <option value="monthly">月线</option>
                </select>
                <button onclick="searchStock()">查询</button>
            </div>
            <div id="scoreChartTitle" class="gradient-title">分析报告得分折线图</div>
            <div id="scoreChart"></div>
            <div id="chartTitle" class="gradient-title">K线图</div>
            <div id="chart"></div>
            <div id="stockInfo">
                <div id="stockInfoSummary">点击查看股票基本信息</div>
                <div id="stockInfoDetail" style="display:none;"></div>
            </div>
            <table id="customTable">
                <thead>
                    <tr><th colspan="4"><span class="gradient-title">分析报告</span></th></tr>
                </thead>
                <tbody id="customTableBody">
                    <tr><td>请选择股票加载分析报告</td></tr>
                </tbody>
            </table>
        </div>
        <div class="tab-content" id="tab2"><h1>其他功能1</h1><p>这里可以扩展其他功能。</p></div>
        <div class="tab-content" id="tab3"><h1>其他功能2</h1><p>这里可以扩展其他功能。</p></div>
    </div>
</div>

<script>
let chart, candleSeries, volumeSeries, ema5Series, ema20Series;
let scoreChart, scoreLineSeries, priceLineSeries, scoreLineWarning, scoreLineGood;
let currentSymbol='';
let latestKlines=[];
let isChartInit=false, isScoreChartInit=false;

// ===== 图表初始化 =====
function initChart(){
    const container=document.getElementById('chart');
    chart = LightweightCharts.createChart(container,{width:container.clientWidth,height:600,layout:{background:{color:'#fff'},textColor:'#333'},grid:{vertLines:{color:'#eee'},horzLines:{color:'#eee'}},timeScale:{timeVisible:true}});
    candleSeries=chart.addCandlestickSeries({upColor:'#26a69a',downColor:'#ef5350',borderUpColor:'#26a69a',borderDownColor:'#ef5350',wickUpColor:'#26a69a',wickDownColor:'#ef5350'});
    volumeSeries=chart.addHistogramSeries({color:'#26a69a',priceFormat:{type:'volume'},priceScaleId:'',scaleMargins:{top:0.8,bottom:0}});
    ema5Series=chart.addLineSeries({color:'#f39c12',lineWidth:2});
    ema20Series=chart.addLineSeries({color:'#2980b9',lineWidth:2});
    isChartInit=true;
}
function initScoreChart(){
    const container=document.getElementById('scoreChart');
    scoreChart = LightweightCharts.createChart(container,{width:container.clientWidth,height:300,layout:{background:{color:'#fff'},textColor:'#333'},grid:{vertLines:{color:'#eee'},horzLines:{color:'#eee'}},timeScale:{timeVisible:true},leftPriceScale:{visible:true},rightPriceScale:{visible:true}});
    scoreLineSeries=scoreChart.addLineSeries({priceScaleId:'right',color:getColorByScore(0.2),lineWidth:3,title:'得分',priceLineVisible:false,crosshairMarkerVisible:true});
    priceLineSeries=scoreChart.addLineSeries({priceScaleId:'left',color:'rgba(0,0,0,0.7)',lineWidth:2,title:'📈 收盘价',priceLineVisible:false,crosshairMarkerVisible:true,lineStyle:0});
    scoreLineWarning=scoreChart.addLineSeries({color:getColorByScore(-0.1),lineWidth:1,title:'🐻 离场线',crosshairMarkerVisible:false,lineStyle:0});
    scoreLineGood=scoreChart.addLineSeries({color:getColorByScore(0.7),lineWidth:1,title:'🐮 入场线',crosshairMarkerVisible:false,lineStyle:0});
    isScoreChartInit=true;
}

// ===== Tab切换逻辑 =====
function setupTabs(){
    document.querySelectorAll('.tab-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
            document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(tab=>tab.classList.remove('active'));
            const targetTab=document.getElementById(btn.dataset.tab);
            targetTab.classList.add('active');
            if(btn.dataset.tab==='tab1'){
                if(!isChartInit) initChart();
                if(!isScoreChartInit) initScoreChart();
                if(!currentSymbol) loadStocks();
            }
        });
    });
}

// ===== 折叠导航栏 =====
document.getElementById('toggleSidebar').addEventListener('click',()=>{
    const sidebar=document.getElementById('sidebar');
    sidebar.classList.toggle('collapsed');
});

// ===== 工具函数 =====
function getAfterThink(text) {const tag = '</think>';const idx = text.indexOf(tag);if(idx === -1) return text;return text.substring(idx + tag.length).trim();}
function calculateEMA(data, period){
    const k=2/(period+1); const emaArray=[]; let emaPrev=data[0].close;
    data.forEach((d,i)=>{const ema=i===0?d.close:d.close*k+emaPrev*(1-k); emaArray.push(ema); emaPrev=ema;});
    return emaArray;
}
function getColorByScore(score){if(score>=0.5) return '#27ae60';else if(score>=0.2) return '#f1c40f';else return '#c0392b';}
function scoreClass(score){ if(score===null||score===undefined) return 'score-yellow'; if(score>=0.5) return 'score-green'; else if(score>=0.2) return 'score-yellow'; else return 'score-red'; }
function getRandomColor(){ const palette=['#42a5f5','#ef5350','#66bb6a','#ab47bc','#ffa726','#26c6da','#ffca28']; return palette[Math.floor(Math.random()*palette.length)]; }
const indicatorColors={EMA:['#42A5F5','#64B5F6','#90CAF9'],MACD:['#AB47BC','#BA68C8','#CE93D8'],VOL:['#FFA726','#FFB74D','#FFCC80'],PRICE:['#EF5350','#E57373','#EF9A9A'],RSI:['#26C6DA','#4DD0E1','#80DEEA'],KDJ:['#FFD54F','#FFEB3B','#FFF176'],BOLL:['#81D4FA','#4FC3F7','#29B6F6']};
function getRandomFromArray(arr){return arr[Math.floor(Math.random()*arr.length)];}
function showReport(text){
    text = marked.parse(getAfterThink(text))
    return text
    .replace(/\b(EMA|ema_short|ema_long)\b/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.EMA)};font-weight:600;">${m}</span>`)
    .replace(/\b(MACD)\b/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.MACD)};font-weight:600;">${m}</span>`)
    .replace(/(?<![A-Za-z0-9])(成交量|VOL)(?![A-Za-z0-9])/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.VOL)};font-weight:600;">${m}</span>`)
    .replace(/(?<![A-Za-z0-9])(趋势)(?![A-Za-z0-9])/g,m=>`<span style="color:${getRandomColor()};font-weight:600;">${m}</span>`)
    .replace(/(?<![A-Za-z0-9])(动量|动能)(?![A-Za-z0-9])/g,m=>`<span style="color:${getRandomColor()};font-weight:600;">${m}</span>`)
    .replace(/(?<![A-Za-z0-9])(价格|price)(?![A-Za-z0-9])/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.PRICE)};font-weight:600;">${m}</span>`)
    .replace(/\b(RSI)\b/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.RSI)};font-weight:600;">${m}</span>`)
    .replace(/\b(KDJ|KD|J)\b/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.KDJ)};font-weight:600;">${m}</span>`)
    .replace(/(?<![A-Za-z0-9])(布林带|BOLL)(?![A-Za-z0-9])/g,m=>`<span style="color:${getRandomFromArray(indicatorColors.BOLL)};font-weight:600;">${m}</span>`)
    .replace(/<score>(.*?)<\/score>/g, (m,p1)=>{const s=parseFloat(p1); const color=getColorByScore(s); return `<div style="margin:4px 0;padding:4px 8px;border-left:3px solid #43a047;background:#f1f8e9;font-size:14px;display:inline-block;">综合评分：<b><span style="color:${color};">${s}</span></b></div>`;})
}
function parseScoreFromReport(text){try{const m = /<score>\s*([+-]?\d+(\.\d+)?)\s*<\/score>/i.exec(text);if(m && m[1]) return parseFloat(m[1]);}catch(e){}return null;}
function formatMarketCap(value){ if(!value) return 'N/A'; return (value/1e8).toFixed(2)+'亿'; }

function renderChartBadge(score){
    const existing = document.querySelector('.chart-badge');
    if(existing) existing.remove();
    const badge = document.createElement('div');
    badge.className='chart-badge small';
    badge.style.zIndex=9999;
    if(score===null || score===undefined){badge.innerText='评分: -';badge.style.background='#95a5a6';
    } else {badge.innerText = (score>0?`+${score.toFixed(2)}`:score.toFixed(2));badge.style.background = getColorByScore(score);}
    document.getElementById('content').appendChild(badge);
}
// ===== 加载股票列表 =====
async function loadStocks(){
    const response=await fetch('/stocks'); if(!response.ok) return;
    const stocks=await response.json();
    const selector=document.getElementById('stockSelector'); selector.innerHTML='<option value="">选择股票</option>';
    stocks.forEach(stock=>{const opt=document.createElement('option'); opt.value=stock.symbol; opt.textContent=`${stock.symbol}`; selector.appendChild(opt);});
    selector.onchange=()=>{const s=selector.value; if(s){currentSymbol=s; searchStock(s); document.getElementById('stockSearch').value=s;}};
    if(stocks.length>0){ currentSymbol=stocks[0].symbol; selector.value=currentSymbol; document.getElementById('stockSearch').value=currentSymbol; searchStock(currentSymbol);}
}

// ===== 加载股票信息 =====
async function loadStockInfo(symbol){
    const response=await fetch(`/stock_info/${symbol}`);
    if(!response.ok) return;
    const info=await response.json();
    const detailDiv=document.getElementById('stockInfoDetail');
    detailDiv.innerHTML=`<b>${info.symbol}</b> - ${info.name}<br>行业: <b>${info.industry||'未知'}</b> | 市值:<b>${formatMarketCap(info.market_cap)}</b><br>info: ${info.info||'-'}`;
    const summaryDiv=document.getElementById('stockInfoSummary');
    summaryDiv.onclick=()=>{if(detailDiv.style.display==='none'){detailDiv.style.display='block'; summaryDiv.innerText='点击收起股票基本信息';} else {detailDiv.style.display='none'; summaryDiv.innerText='点击查看股票基本信息';}};
}

// ===== 查询股票 =====
async function searchStock(symbol=null){
    let sym=symbol||document.getElementById('stockSearch').value.trim()||document.getElementById('stockSelector').value;
    sym=sym.toUpperCase();
    if(!sym){alert('请输入或选择股票代码'); return;} currentSymbol=sym;
    const interval=document.getElementById('intervalSelector').value;
    await loadStockInfo(sym);

    document.getElementById('chartTitle').innerHTML = `<span class="gradient-title">${currentSymbol} K线图</span>`;
    document.getElementById('scoreChartTitle').innerHTML = `<span class="gradient-title">${currentSymbol} 分析报告得分</span>`;

    const response=await fetch(`/klines/${sym}?interval=${interval}`);
    if(!response.ok){alert('未找到该股票的K线数据'); return;}
    const klines=await response.json(); latestKlines=klines;
    const formatted=klines.map(k=>({time:k.date,open:k.open,high:k.high,low:k.low,close:k.close}));
    candleSeries.setData(formatted); chart.timeScale().fitContent();
    const volData=klines.map(k=>({time:k.date,value:k.volume,color:k.close>=k.open?'#26a69a':'#ef5350'}));
    volumeSeries.setData(volData);
    const ema5=calculateEMA(formatted,5); const ema20=calculateEMA(formatted,20);
    ema5Series.setData(formatted.map((d,i)=>({time:d.time,value:ema5[i]})));
    ema20Series.setData(formatted.map((d,i)=>({time:d.time,value:ema20[i]})));

    const reportResp=await fetch(`/quant_report/${sym}`); let reportData=[];
    if(reportResp.ok){ reportData=await reportResp.json();}
    const tbody=document.getElementById('customTableBody'); tbody.innerHTML='';
    const tableHead = document.querySelector('#customTable thead tr th');
    tableHead.colSpan = 4;
    tableHead.innerHTML = `<span class="gradient-title">${currentSymbol} 股票分析报告</span>`;

    if(reportData.length>0){
        reportData.sort((a,b)=>new Date(b.date)-new Date(a.date));
        const headerTr=document.createElement('tr');
        headerTr.style.textAlign='center'; 
        headerTr.innerHTML=`<th>日期</th><th>收盘价</th><th>得分</th><th>📊滤网报告📊</th>`;
        tbody.appendChild(headerTr);
        latest_score = parseScoreFromReport(reportData[0].three_filters_report)
        renderChartBadge(latest_score) 
        reportData.forEach(row=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`
                <td style="width:120px"><b>${row.date}</b></br>更新:${row.update_time}</td>
                <td style="width:80px"><b>${row.price?.toFixed(2)||'-'}</b></td>
                <td style="color:${getColorByScore(row.three_filters_score)}; font-size:30px">${row.three_filters_score??'-'}</td>
                <td style="vertical-align: top;">${showReport(row.three_filters_report)||'-'}</td>`;
            tbody.appendChild(tr);
        });

        const priceData = reportData.filter(r=>r.three_filters_score!==null).map(r=>({time:r.date,value:r.price?.toFixed(2)})).sort((a,b)=>new Date(a.time)-new Date(b.time));
        const scoreData = reportData.filter(r=>r.three_filters_score!==null).map(r=>({time:r.date,value:parseFloat(r.three_filters_score)})).sort((a,b)=>new Date(a.time)-new Date(b.time));
        warningData = scoreData.map(d => ({ ...d, value: 0.0 }));
        goodData = scoreData.map(d => ({ ...d, value: 0.7 }));
        console.log(priceData)
        if(scoreData.length>0){priceLineSeries.setData(priceData);scoreLineSeries.setData(scoreData);scoreLineWarning.setData(warningData);scoreLineGood.setData(goodData);scoreChart.timeScale().fitContent();}
    } else { tbody.innerHTML='<tr><td>暂无分析报告</td></tr>'; }
}

// ===== 初始化 =====
document.addEventListener('DOMContentLoaded',()=>{
    setupTabs();
    if(!isChartInit) initChart();
    if(!isScoreChartInit) initScoreChart();
    loadStocks();
});
window.onresize=()=>{
    if(chart) chart.applyOptions({width:document.getElementById('chart').clientWidth});
    if(scoreChart) scoreChart.applyOptions({width:document.getElementById('scoreChart').clientWidth});
};
</script>
</body>
</html>

